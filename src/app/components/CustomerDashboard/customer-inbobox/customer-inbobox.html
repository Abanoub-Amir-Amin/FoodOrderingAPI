
    <div>
        <input type="text" id="userName" placeholder="Enter user name">
        <input type="text" id="password" placeholder="Enter password">
        <button id="login">Login</button><br><br>
    </div>
    <div class="app-container">
        
        <div class="customerChat-container">
            <div class="customerChat-header">
                <h1 class="customerChat-title">Chat with admin</h1>
            </div>

        <div class="chat-history" id="chatHistory">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <p>Start a conversation with admin</p>
                <p style="font-size: 0.875rem; opacity: 0.7;">Type a message below to get started</p>
            </div>
        </div>

        <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="Type your message here..." rows="1"></textarea>
            <button class="send-button" id="sendButton">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        var senderId = null;
        var receiverId = null;
        var connection;
        var senders = [];
        document.getElementById("login").addEventListener("click", async function (event) {
            event.preventDefault();
            const userName = document.getElementById("userName").value;
            const password = document.getElementById("password").value;
            var isLogged = await fetch("https://localhost:7060/api/Auth/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ userName, password }),
            credentials: "include"
            });
            if(isLogged.ok){
                console.log("User logged in successfully.");
                // Now wait for the login to fully process before calling protected endpoint
                const res = await fetch("https://localhost:7060/api/Chat/id", {
                    credentials: "include"
                });
                if (res.ok) {
                    senderId = await res.text();
                    console.log("Current User ID: ", senderId);
                } else {
                    console.error("Failed to get user ID", res.status);
                }

                
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("https://localhost:7060/chathub", {
                        withCredentials: true
                    })
                    .build();
                connection.start()
                    .then(() => {
                        connection.on("ReceiveMessage", function (senderId, message) {
                            addMessage(message, false);
                        });
                        console.log("SignalR connected.");
                    })
                    .catch(err => console.error("SignalR connection failed:", err));

                const response = await fetch(`https://localhost:7060/api/chat/GetChatMessages/${senderId}`, {
                    method: "GET",
                    credentials: "include"
                });

                const data = await response.json();
                const messages = data.$values;

                console.log(messages);
                for (let i = 0; i < messages.length; i++) {
                    if(messages[i].sender === senderId){
                        addMessage(messages[i].message, true);
                    } else {
                        addMessage(messages[i].message, false);
                    }
                }
            }
            else{
                console.error("Login failed.");
            }
        
    });

        let messages = [];

        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(content, isOutgoing = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
            
            const time = formatTime();
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${content}
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Remove empty state if it exists
            const emptyState = chatHistory.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message incoming typing-message';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatHistory.appendChild(typingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return typingDiv;
        }

        function removeTypingIndicator() {
            const typingMessage = chatHistory.querySelector('.typing-message');
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        async function sendMessage() {
            

            var message = chatInput.value.trim();
            if (message === '') return;

            addMessage(message, true);
            
            receiverId = 'Admin0';
            await fetch("https://localhost:7060/api/chat/sendmessage", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ ReceiverId: 'Admin0', senderId, message, CustomerId: senderId }),
                credentials: "include"
            });

            chatInput.value = '';
            adjustTextareaHeight();

        }

        function adjustTextareaHeight() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        chatInput.addEventListener('input', adjustTextareaHeight);

        

        // Auto-resize textarea on load
        adjustTextareaHeight();
    </script>
    </div>
