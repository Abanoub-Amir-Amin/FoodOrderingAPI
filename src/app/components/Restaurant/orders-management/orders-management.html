<div class="orders-management-container">
  <h2>Manage Orders</h2>

  <mat-form-field appearance="fill" class="filter-dropdown">
    <mat-label>Filter Orders by Status</mat-label>
    <mat-select [(value)]="selectedStatusFilter" (selectionChange)="onStatusFilterChange($event.value)">
      <mat-option *ngFor="let status of allowedStatuses" [value]="status">
        {{ status }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <mat-progress-spinner *ngIf="isLoading" mode="indeterminate"></mat-progress-spinner>

  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="!isLoading && filteredOrders.length === 0" class="no-orders">No orders found.</div>

  <div *ngFor="let order of filteredOrders" class="order-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Order #{{ order.OrderNumber || order.OrderID }}</mat-card-title>
        <mat-card-subtitle>Status: {{ order.Status }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="order-details">
          <div class="order-info">
            <strong>Placed At:</strong> {{ order.OrderDate | date: 'medium' }}<br />
            <strong>Customer:</strong> {{ order.Customer?.FirstName }} {{ order.Customer?.LastName }}<br />
            <strong>Email:</strong> {{ order.Customer?.Email }}<br />
            <strong>Phone:</strong> {{ order.Customer?.Phone }}
          </div>

          <div class="order-items">
            <h4>Items:</h4>

            <ul *ngIf="order.orderItems?.$values?.length; else noItems">
              <li *ngFor="let item of order.orderItems.$values">
                <img
                  [src]="getImageUrl(item.imageUrl) || 'assets/food-placeholder.jpg'"
                  alt="{{ item.ItemName }}"
                  width="60"
                  height="40"
                />
                {{ item.itemName }} - Qty: {{ item.quantity }}<br />
                <small>Preferences: {{ item.preferences || 'None' }}</small>
              </li>
            </ul>

            <ng-template #noItems>
              <small>No items in this order.</small>
            </ng-template>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <!-- Show Accept only if WaitingToConfirm -->
        <button mat-button color="primary" *ngIf="order.Status === 'WaitingToConfirm'" (click)="acceptOrder(order)">
          Accept
        </button>

        <!-- Show Submit Finished only if Preparing -->
        <button mat-button color="accent" *ngIf="order.Status === 'Preparing'" (click)="finishOrder(order)">
          Submit Finished
        </button>

        <!-- Show Reject only if WaitingToConfirm -->
        <button mat-button color="warn" *ngIf="order.Status === 'WaitingToConfirm'" (click)="rejectOrder(order)">
          Reject
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
