@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model FoodOrderingAPI.DTO.DashboardDto

@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container-fluid mt-3">
    <h1>@ViewData["Title"]</h1>

    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-light sidebar border-end" style="min-height:80vh;">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column nav-pills" id="dashboardTabs" role="tablist" aria-orientation="vertical">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab" data-bs-toggle="pill" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">
                            Admin Control
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="restaurant-tab" data-bs-toggle="pill" data-bs-target="#restaurant" type="button" role="tab" aria-controls="restaurant" aria-selected="true">
                            Restaurant Control
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customer-tab" data-bs-toggle="pill" data-bs-target="#customer" type="button" role="tab" aria-controls="customer" aria-selected="false">
                            Customer Control
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="Orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="false">
                            Orders Control
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="deliveryman-tab" data-bs-toggle="pill" data-bs-target="#deliveryman" type="button" role="tab" aria-controls="deliveryman" aria-selected="false">
                            Delivery Man Control
                        </button>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4">
            <div class="tab-content" id="dashboardTabsContent">

                <!-- Restaurants tab -->
                <div class="tab-pane fade show active" id="restaurant" role="tabpanel" aria-labelledby="restaurant-tab">
                    <h2>Active Restaurants</h2>
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr><th>Name</th><th>Location</th><th>Open Hours</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var rest in Model.ActiveRestaurants)
                            {
                                <tr>
                                    <td>@rest.RestaurantName</td>
                                    <td>@rest.Location</td>
                                    <td>@rest.OpenHours</td>
                                    <td>
                                        <form asp-action="DeactivateRestaurant" method="post" style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@rest.User.UserName" />
                                            <button class="btn btn-warning btn-sm" type="submit">Deactivate</button>
                                        </form>

                                        <form asp-action="DeleteRestaurant" method="post" style="display:inline;" onsubmit="return confirm('Confirm delete?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@rest.User.UserName" />
                                            <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                                        </form> 
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <h2>Inactive Restaurants</h2>
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr><th>Name</th><th>Location</th><th>Open Hours</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var rest in Model.InactiveRestaurants)
                            {
                                <tr>
                                    <td>@rest.RestaurantName</td>
                                    <td>@rest.Location</td>
                                    <td>@rest.OpenHours</td>
                                    <td>
                                        <form asp-action="ActivateRestaurant" method="post" style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@rest.User.UserName" />
                                            <button class="btn btn-success btn-sm" type="submit">Activate</button>
                                        </form>
                                        <form asp-action="DeleteRestaurant" method="post" style="display:inline;" onsubmit="return confirm('Confirm delete?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@rest.User.UserName" />
                                            <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Delivery Man tab -->
                <div class="tab-pane fade" id="deliveryman" role="tabpanel" aria-labelledby="deliveryman-tab">
                    <h2>Delivery Men</h2>
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>UserName</th>
                                <th>Email</th>
                                <th>Rank</th> 
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dm in Model.DeliveryMen)
                            {
                                <tr>
                                    <td>@dm.User.UserName</td>
                                    <td>@dm.User.Email</td>
                                    <td>@dm.Rank</td>
                                    <td>@(dm.AvailabilityStatus ? "Yes" : "No")</td>
                                    <td>
                                        <form asp-action="DeleteDeliveryMan" method="post" onsubmit="return confirm('Confirm delete delivery man?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@dm.DeliveryManId" />
                                            <button class="btn btn-danger btn-sm">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Customers -->
                <div class="tab-pane fade" id="customer" role="tabpanel" aria-labelledby="customer-tab">
                    <h2>Customers</h2>
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>UserName</th>
                                <th>Email</th>
                                <th>Loyalty Points</th>
                                <th>Total Orders</th>
                                <th>Delivered Orders</th>
                                <th>Cancelled Orders</th>
                                <th>In-Process Orders</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var customer in Model.Customers)
                            {
                                <tr>
                                    <td>@customer.UserName</td>
                                    <td>@customer.Email</td>
                                    @* <td>@customer.LoyaltyPoints</td> *@
                                    <td>@customer.TotalOrders</td>
                                    <td>@customer.TotalDeliveredOrders</td>
                                    <td>@customer.TotalCancelledOrders</td>
                                    <td>
                                        @if (customer.InProcessOrders != null && customer.InProcessOrders.Any())
                                        {
                                            <ul>
                                                @foreach (var order in customer.InProcessOrders)
                                                {
                                                    <li>
                                                        Order Date: @order.OrderDate.ToShortDateString(), Total: @order.TotalPrice.ToString("C"),
                                                        Status: @order.Status,
                                                        Items: @string.Join(", ", order.OrderItems.Select(o => o.itemName + " (x" + o.Quantity + ")"))
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <em>No In-Process Orders</em>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Admin tab -->
                <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                    <h2>Admins</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>UserName</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var admin in Model.Admins)
                            {
                                <tr>
                                    <td>@admin.User.UserName</td>
                                    <td>@admin.User.Email</td>
                                    <td>@admin.User.Phone</td>
                                    <td>
                                        <a asp-action="EditAdmin" asp-route-userId="@admin.User.UserName" class="btn btn-primary btn-sm">Update</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>


                <!-- Orders tab -->
                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                    <h2>Orders</h2>
                    <h2 style="text-align: right;">
                        <form method="get" class="mb-3">
                            <label>Status:</label>
                            <select asp-for="SelectedStatus" asp-items="Model.StatusList" class="form-select" style="width: 200px; display: inline-block;"></select>
                            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                        </form>
                    </h2>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Restaurant ID</th>
                                <th>Order Date</th>
                                <th>Status</th>
                                <th>Total Price</th>
                                <th>Order Items</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.Orders) 
                            {
                                <tr>
                                    <td>@order.Customer.FirstName + @order.Customer.LastName</td>
                                    <td>@order.RestaurantID</td>
                                    <td>@order.OrderDate.ToShortDateString()</td>
                                    <td>@order.Status</td>
                                    <td>@order.TotalPrice.ToString("C")</td>
                                    <td>
                                        <ul>
                                            @foreach (var item in order.OrderItems)
                                            {
                                                <li>@item.itemName (@item.Quantity)</li>
                                            }
                                        </ul>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
